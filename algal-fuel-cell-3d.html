<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Advanced Algal Fuel Cell Designer - Professional Bio-Electrochemical System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: radial-gradient(ellipse at center, #001122 0%, #000000 100%);
        }

        /* Glass morphism UI panels */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.1);
        }

        /* Tab system */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }

        .tab-button {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
        }

        .tab-button.active {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 420px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            padding: 25px;
            transition: all 0.3s ease;
        }

        #control-panel::-webkit-scrollbar {
            width: 8px;
        }

        #control-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        #control-panel::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
            border-radius: 4px;
        }

        #control-panel h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00ff88 0%, #00ffff 50%, #ff00ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .subtitle {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .parameter-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #000;
            box-shadow: 0 0 15px currentColor;
        }

        .parameter-group {
            margin-bottom: 15px;
        }

        .parameter-label {
            display: block;
            font-size: 13px;
            color: #aaa;
            margin-bottom: 8px;
            font-weight: 500;
            position: relative;
        }

        .parameter-value {
            color: #00ff88;
            font-weight: 600;
            float: right;
        }

        .tooltip {
            position: absolute;
            right: 0;
            top: 0;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: help;
            transition: all 0.3s ease;
        }

        .tooltip:hover {
            background: rgba(0, 255, 136, 0.2);
            transform: scale(1.2);
        }

        .tooltip-content {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
            line-height: 1.4;
            width: 200px;
            display: none;
            z-index: 1000;
        }

        .tooltip:hover .tooltip-content {
            display: block;
        }

        select, input[type="range"], input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        select {
            cursor: pointer;
        }

        select:hover, select:focus, input:hover, input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #00ff88;
            outline: none;
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00ff88;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            transition: all 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
        }

        /* Advanced controls toggle */
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .advanced-toggle:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: rgba(0, 255, 136, 0.5);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 22px;
            background: #00ff88;
        }

        /* Performance display */
        #performance-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 360px;
            padding: 25px;
        }

        .performance-metric {
            margin-bottom: 20px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 13px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #00ff88, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-unit {
            font-size: 14px;
            color: #00ff88;
            margin-left: 5px;
        }

        .performance-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ffff);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px currentColor;
        }

        /* Control buttons */
        #view-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            padding: 15px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(0, 255, 136, 0.3) 0%, transparent 70%);
            transition: width 0.3s, height 0.3s;
            transform: translate(-50%, -50%);
        }

        .control-btn:hover::before {
            width: 100px;
            height: 100px;
        }

        .control-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .control-btn.active {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        /* Charts container */
        #charts-panel {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 360px;
            height: 250px;
            padding: 20px;
            display: none;
        }

        #performance-chart {
            width: 100%;
            height: 100%;
        }

        /* Loading screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #001122 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loader-container {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .loader {
            width: 100%;
            height: 100%;
            border: 3px solid rgba(0, 255, 136, 0.1);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 30px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            #control-panel {
                width: calc(100% - 20px);
                left: 10px;
                right: 10px;
                max-height: 50vh;
            }

            #performance-panel {
                display: none;
            }

            #charts-panel {
                display: none;
            }

            #view-controls {
                bottom: 20px;
                gap: 8px;
                padding: 12px;
            }

            .control-btn {
                padding: 10px 16px;
                font-size: 12px;
            }

            .parameter-section {
                padding: 15px;
            }

            #control-panel h1 {
                font-size: 22px;
            }
        }

        /* Error message */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            max-width: 400px;
            text-align: center;
            display: none;
            z-index: 1001;
        }

        /* Preset buttons */
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .preset-btn {
            padding: 10px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            color: #00ff88;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .preset-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            transform: translateY(-1px);
        }

        .preset-btn.loading {
            pointer-events: none;
            opacity: 0.5;
        }

        /* Multi-select for mediators */
        .multi-select {
            position: relative;
        }

        .multi-select-display {
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #aaa;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .multi-select-dropdown.open {
            display: block;
        }

        .multi-select-option {
            padding: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-select-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .multi-select-option.selected {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
        }

        .multi-select-checkbox {
            width: 16px;
            height: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            position: relative;
        }

        .multi-select-option.selected .multi-select-checkbox {
            background: #00ff88;
            border-color: #00ff88;
        }

        .multi-select-option.selected .multi-select-checkbox::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 12px;
        }

        /* State save/load buttons */
        .state-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .state-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .state-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ff88;
            color: #00ff88;
        }

        /* Validation feedback */
        .validation-error {
            color: #ff4444;
            font-size: 11px;
            margin-top: 5px;
            display: none;
        }

        input.error, select.error {
            border-color: #ff4444;
        }

        /* History panel */
        #history-panel {
            position: absolute;
            top: 20px;
            left: 460px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .history-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .history-timestamp {
            font-size: 11px;
            color: #666;
        }

        .history-performance {
            font-size: 14px;
            color: #00ff88;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loader-container">
            <div class="loader"></div>
        </div>
        <div class="loading-text">Initializing Advanced Bio-System</div>
    </div>

    <div id="canvas-container"></div>

    <div id="control-panel" class="glass-panel">
        <h1>Advanced Fuel Cell Designer</h1>
        <p class="subtitle">Professional bio-electrochemical system configurator</p>
        
        <div class="advanced-toggle" onclick="toggleAdvancedMode()">
            <span>Advanced Parameters</span>
            <div class="toggle-switch" id="advanced-toggle"></div>
        </div>

        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('biological')">Biological</button>
            <button class="tab-button" onclick="switchTab('electrochemical')">Electrochemical</button>
            <button class="tab-button" onclick="switchTab('operational')">Operational</button>
            <button class="tab-button" onclick="switchTab('analysis')">Analysis</button>
        </div>

        <!-- Biological Parameters Tab -->
        <div id="biological-tab" class="tab-content active">
            <!-- Microalgae Configuration -->
            <div class="parameter-section">
                <h3 class="section-title">
                    <span class="section-icon">🦠</span>
                    Microalgae Configuration
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Primary Species
                        <span class="parameter-value" id="algae-type-value">Mixed Culture</span>
                        <span class="tooltip">?
                            <div class="tooltip-content">
                                Different algae species have varying photosynthetic efficiencies and electron transfer rates
                            </div>
                        </span>
                    </label>
                    <select id="algae-type" onchange="updateParameter('algae', 'type')">
                        <option value="mixed">Mixed Culture (Chlorella + Spirulina)</option>
                        <option value="chlorella">Chlorella vulgaris</option>
                        <option value="spirulina">Spirulina platensis</option>
                        <option value="scenedesmus">Scenedesmus obliquus</option>
                        <option value="dunaliella">Dunaliella salina</option>
                        <option value="chlamydomonas">Chlamydomonas reinhardtii</option>
                        <option value="synechocystis">Synechocystis sp.</option>
                        <option value="anabaena">Anabaena variabilis</option>
                    </select>
                    <div class="validation-error" id="algae-type-error"></div>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Cell Density
                        <span class="parameter-value" id="cell-density-value">5.0 × 10⁶ cells/mL</span>
                    </label>
                    <input type="range" id="cell-density" min="0.1" max="50" value="5" step="0.1" 
                           onchange="updateParameter('algae', 'density')">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Culture Volume
                        <span class="parameter-value" id="culture-volume-value">100 mL</span>
                    </label>
                    <input type="range" id="culture-volume" min="1" max="5000" value="100" step="10" 
                           onchange="updateParameter('algae', 'volume')">
                </div>
                <div class="parameter-group advanced-param" style="display: none;">
                    <label class="parameter-label">
                        Growth Phase
                        <span class="parameter-value" id="growth-phase-value">Exponential</span>
                    </label>
                    <select id="growth-phase" onchange="updateParameter('algae', 'growthPhase')">
                        <option value="lag">Lag Phase</option>
                        <option value="exponential" selected>Exponential Phase</option>
                        <option value="stationary">Stationary Phase</option>
                        <option value="decline">Decline Phase</option>
                    </select>
                </div>
                <div class="parameter-group advanced-param" style="display: none;">
                    <label class="parameter-label">
                        Biofilm Formation
                        <span class="parameter-value" id="biofilm-value">20%</span>
                    </label>
                    <input type="range" id="biofilm" min="0" max="100" value="20" step="5" 
                           onchange="updateParameter('algae', 'biofilm')">
                </div>
            </div>

            <!-- Mediator Configuration -->
            <div class="parameter-section advanced-param" style="display: none;">
                <h3 class="section-title">
                    <span class="section-icon">⚗️</span>
                    Electron Mediators
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Mediator Compounds
                        <span class="tooltip">?
                            <div class="tooltip-content">
                                Electron mediators facilitate electron transfer between cells and electrodes
                            </div>
                        </span>
                    </label>
                    <div class="multi-select">
                        <div class="multi-select-display" onclick="toggleMultiSelect('mediators')">
                            <span id="mediators-display">Select mediators...</span>
                        </div>
                        <div class="multi-select-dropdown" id="mediators-dropdown">
                            <div class="multi-select-option" data-value="none" onclick="selectMediator('none')">
                                <div class="multi-select-checkbox"></div>
                                <span>No mediator</span>
                            </div>
                            <div class="multi-select-option" data-value="methylene-blue" onclick="selectMediator('methylene-blue')">
                                <div class="multi-select-checkbox"></div>
                                <span>Methylene Blue</span>
                            </div>
                            <div class="multi-select-option" data-value="neutral-red" onclick="selectMediator('neutral-red')">
                                <div class="multi-select-checkbox"></div>
                                <span>Neutral Red</span>
                            </div>
                            <div class="multi-select-option" data-value="ferricyanide" onclick="selectMediator('ferricyanide')">
                                <div class="multi-select-checkbox"></div>
                                <span>Ferricyanide</span>
                            </div>
                            <div class="multi-select-option" data-value="quinone" onclick="selectMediator('quinone')">
                                <div class="multi-select-checkbox"></div>
                                <span>Quinone</span>
                            </div>
                            <div class="multi-select-option" data-value="riboflavin" onclick="selectMediator('riboflavin')">
                                <div class="multi-select-checkbox"></div>
                                <span>Riboflavin</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Mediator Concentration
                        <span class="parameter-value" id="mediator-conc-value">0.1 mM</span>
                    </label>
                    <input type="range" id="mediator-conc" min="0" max="10" value="0.1" step="0.1" 
                           onchange="updateParameter('mediators', 'concentration')">
                </div>
            </div>

            <!-- Nutrient Medium -->
            <div class="parameter-section advanced-param" style="display: none;">
                <h3 class="section-title">
                    <span class="section-icon">🧪</span>
                    Culture Medium
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Medium Type
                        <span class="parameter-value" id="medium-type-value">BG-11</span>
                    </label>
                    <select id="medium-type" onchange="updateParameter('medium', 'type')">
                        <option value="bg11">BG-11</option>
                        <option value="tris">Tris-Acetate-Phosphate (TAP)</option>
                        <option value="bold">Bold's Basal Medium</option>
                        <option value="f2">f/2 Medium</option>
                        <option value="zarrouk">Zarrouk's Medium</option>
                        <option value="custom">Custom Formulation</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Nitrogen Source
                        <span class="parameter-value" id="nitrogen-value">Nitrate</span>
                    </label>
                    <select id="nitrogen-source" onchange="updateParameter('medium', 'nitrogen')">
                        <option value="nitrate">Nitrate (NO₃⁻)</option>
                        <option value="ammonium">Ammonium (NH₄⁺)</option>
                        <option value="urea">Urea</option>
                        <option value="mixed">Mixed N sources</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Phosphate Conc.
                        <span class="parameter-value" id="phosphate-value">1.0 mM</span>
                    </label>
                    <input type="range" id="phosphate" min="0.1" max="10" value="1" step="0.1" 
                           onchange="updateParameter('medium', 'phosphate')">
                </div>
            </div>
        </div>

        <!-- Electrochemical Parameters Tab -->
        <div id="electrochemical-tab" class="tab-content">
            <!-- Electrode Configuration -->
            <div class="parameter-section">
                <h3 class="section-title">
                    <span class="section-icon">⚡</span>
                    Electrode Configuration
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Anode Material
                        <span class="parameter-value" id="anode-material-value">Graphene</span>
                    </label>
                    <select id="anode-material" onchange="updateParameter('electrodes', 'anodeMaterial')">
                        <option value="graphene">Graphene</option>
                        <option value="carbon-cloth">Carbon Cloth</option>
                        <option value="carbon-felt">Carbon Felt</option>
                        <option value="graphite">Graphite Rod</option>
                        <option value="cnt">Carbon Nanotubes</option>
                        <option value="biochar">Activated Biochar</option>
                        <option value="rgo">Reduced Graphene Oxide</option>
                        <option value="carbon-paper">Carbon Paper</option>
                        <option value="carbon-brush">Carbon Brush</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Cathode Material
                        <span class="parameter-value" id="cathode-material-value">MXene</span>
                    </label>
                    <select id="cathode-material" onchange="updateParameter('electrodes', 'cathodeMaterial')">
                        <option value="mxene">MXene (Ti₃C₂Tₓ)</option>
                        <option value="platinum">Platinum</option>
                        <option value="graphene-oxide">Graphene Oxide</option>
                        <option value="carbon-cloth-pt">Pt/Carbon Cloth</option>
                        <option value="mno2">MnO₂ Coated Carbon</option>
                        <option value="pani">PANI/Carbon</option>
                        <option value="mos2">MoS₂</option>
                        <option value="co3o4">Co₃O₄ Nanowires</option>
                        <option value="nitrogen-carbon">N-doped Carbon</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Electrode Surface Area
                        <span class="parameter-value" id="electrode-area-value">25 cm²</span>
                    </label>
                    <input type="range" id="electrode-area" min="0.1" max="500" value="25" step="0.1" 
                           onchange="updateParameter('electrodes', 'area')">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Electrode Separation
                        <span class="parameter-value" id="electrode-separation-value">2.0 cm</span>
                    </label>
                    <input type="range" id="electrode-separation" min="0.1" max="20" value="2" step="0.1" 
                           onchange="updateParameter('electrodes', 'separation')">
                </div>
                <div class="parameter-group advanced-param" style="display: none;">
                    <label class="parameter-label">
                        Surface Modification
                        <span class="parameter-value" id="surface-mod-value">None</span>
                    </label>
                    <select id="surface-mod" onchange="updateParameter('electrodes', 'surfaceModification')">
                        <option value="none">None</option>
                        <option value="plasma">Plasma Treatment</option>
                        <option value="acid">Acid Treatment</option>
                        <option value="polymer">Polymer Coating</option>
                        <option value="metal-nanoparticles">Metal Nanoparticles</option>
                        <option value="enzyme">Enzyme Immobilization</option>
                    </select>
                </div>
            </div>

            <!-- Membrane/Separator Configuration -->
            <div class="parameter-section">
                <h3 class="section-title">
                    <span class="section-icon">🔲</span>
                    Separator Configuration
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Separator Type
                        <span class="parameter-value" id="separator-type-value">Proton Exchange</span>
                    </label>
                    <select id="separator-type" onchange="updateParameter('separator', 'type')">
                        <option value="none">No separator</option>
                        <option value="pem">Proton Exchange Membrane</option>
                        <option value="salt-bridge">Salt Bridge</option>
                        <option value="ceramic">Ceramic Membrane</option>
                        <option value="cellulose">Cellulose Membrane</option>
                        <option value="agar">Agar Bridge</option>
                        <option value="glass-frit">Glass Frit</option>
                    </select>
                </div>
                <div class="parameter-group advanced-param" style="display: none;">
                    <label class="parameter-label">
                        Membrane Thickness
                        <span class="parameter-value" id="membrane-thickness-value">0.18 mm</span>
                    </label>
                    <input type="range" id="membrane-thickness" min="0.01" max="1" value="0.18" step="0.01" 
                           onchange="updateParameter('separator', 'thickness')">
                </div>
            </div>

            <!-- Electrical Configuration -->
            <div class="parameter-section advanced-param" style="display: none;">
                <h3 class="section-title">
                    <span class="section-icon">🔌</span>
                    Electrical Configuration
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        External Resistance
                        <span class="parameter-value" id="external-resistance-value">1000 Ω</span>
                    </label>
                    <input type="range" id="external-resistance" min="1" max="10000" value="1000" step="10" 
                           onchange="updateParameter('electrical', 'externalResistance')">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Connection Type
                        <span class="parameter-value" id="connection-type-value">Series</span>
                    </label>
                    <select id="connection-type" onchange="updateParameter('electrical', 'connectionType')">
                        <option value="single">Single Cell</option>
                        <option value="series">Series Connection</option>
                        <option value="parallel">Parallel Connection</option>
                        <option value="series-parallel">Series-Parallel</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Number of Cells
                        <span class="parameter-value" id="cell-count-value">1</span>
                    </label>
                    <input type="range" id="cell-count" min="1" max="10" value="1" step="1" 
                           onchange="updateParameter('electrical', 'cellCount')">
                </div>
            </div>
        </div>

        <!-- Operational Parameters Tab -->
        <div id="operational-tab" class="tab-content">
            <!-- Environmental Parameters -->
            <div class="parameter-section">
                <h3 class="section-title">
                    <span class="section-icon">🌞</span>
                    Environmental Control
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Light Intensity
                        <span class="parameter-value" id="light-intensity-value">200 μmol/m²/s</span>
                        <span class="tooltip">?
                            <div class="tooltip-content">
                                Photosynthetically active radiation (PAR) intensity affects algae growth and electron generation
                            </div>
                        </span>
                    </label>
                    <input type="range" id="light-intensity" min="0" max="1000" value="200" step="10" 
                           onchange="updateParameter('environment', 'lightIntensity')">
                </div>
                <div class="parameter-group advanced-param" style="display: none;">
                    <label class="parameter-label">
                        Light Spectrum
                        <span class="parameter-value" id="light-spectrum-value">White LED</span>
                    </label>
                    <select id="light-spectrum" onchange="updateParameter('environment', 'lightSpectrum')">
                        <option value="white">White LED</option>
                        <option value="red-blue">Red-Blue LED</option>
                        <option value="full-spectrum">Full Spectrum</option>
                        <option value="red">Red (660nm)</option>
                        <option value="blue">Blue (450nm)</option>
                        <option value="green">Green (550nm)</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Temperature
                        <span class="parameter-value" id="temperature-value">25°C</span>
                    </label>
                    <input type="range" id="temperature" min="10" max="45" value="25" step="0.5" 
                           onchange="updateParameter('environment', 'temperature')">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        pH Level
                        <span class="parameter-value" id="ph-value">7.0</span>
                    </label>
                    <input type="range" id="ph" min="4" max="10" value="7" step="0.1" 
                           onchange="updateParameter('environment', 'ph')">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        CO₂ Concentration
                        <span class="parameter-value" id="co2-value">5%</span>
                    </label>
                    <input type="range" id="co2" min="0.04" max="20" value="5" step="0.1" 
                           onchange="updateParameter('environment', 'co2')">
                </div>
            </div>

            <!-- Flow Control -->
            <div class="parameter-section advanced-param" style="display: none;">
                <h3 class="section-title">
                    <span class="section-icon">💧</span>
                    Flow Control
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Operation Mode
                        <span class="parameter-value" id="operation-mode-value">Batch</span>
                    </label>
                    <select id="operation-mode" onchange="updateParameter('flow', 'operationMode')">
                        <option value="batch">Batch</option>
                        <option value="continuous">Continuous</option>
                        <option value="fed-batch">Fed-Batch</option>
                        <option value="semi-continuous">Semi-Continuous</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Flow Rate
                        <span class="parameter-value" id="flow-rate-value">0 mL/min</span>
                    </label>
                    <input type="range" id="flow-rate" min="0" max="100" value="0" step="0.5" 
                           onchange="updateParameter('flow', 'flowRate')">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Mixing Speed
                        <span class="parameter-value" id="mixing-speed-value">100 RPM</span>
                    </label>
                    <input type="range" id="mixing-speed" min="0" max="500" value="100" step="10" 
                           onchange="updateParameter('flow', 'mixingSpeed')">
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Aeration Rate
                        <span class="parameter-value" id="aeration-rate-value">0.5 vvm</span>
                    </label>
                    <input type="range" id="aeration-rate" min="0" max="5" value="0.5" step="0.1" 
                           onchange="updateParameter('flow', 'aerationRate')">
                </div>
            </div>

            <!-- Process Control -->
            <div class="parameter-section advanced-param" style="display: none;">
                <h3 class="section-title">
                    <span class="section-icon">🎛️</span>
                    Process Control
                </h3>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Light/Dark Cycle
                        <span class="parameter-value" id="light-cycle-value">16:8 h</span>
                    </label>
                    <select id="light-cycle" onchange="updateParameter('process', 'lightCycle')">
                        <option value="continuous">Continuous Light</option>
                        <option value="16:8" selected>16h Light : 8h Dark</option>
                        <option value="12:12">12h Light : 12h Dark</option>
                        <option value="18:6">18h Light : 6h Dark</option>
                        <option value="custom">Custom Cycle</option>
                    </select>
                </div>
                <div class="parameter-group">
                    <label class="parameter-label">
                        Retention Time
                        <span class="parameter-value" id="retention-time-value">24 h</span>
                    </label>
                    <input type="range" id="retention-time" min="1" max="168" value="24" step="1" 
                           onchange="updateParameter('process', 'retentionTime')">
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-tab" class="tab-content">
            <!-- Quick Presets -->
            <div class="parameter-section">
                <h3 class="section-title">
                    <span class="section-icon">⚙️</span>
                    Configuration Presets
                </h3>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="loadPreset('optimal')">
                        Optimal<br>Performance
                    </button>
                    <button class="preset-btn" onclick="loadPreset('lowcost')">
                        Low Cost<br>Setup
                    </button>
                    <button class="preset-btn" onclick="loadPreset('highpower')">
                        Maximum<br>Power
                    </button>
                    <button class="preset-btn" onclick="loadPreset('stable')">
                        Most<br>Stable
                    </button>
                    <button class="preset-btn" onclick="loadPreset('research')">
                        Research<br>Grade
                    </button>
                    <button class="preset-btn" onclick="loadPreset('pilot')">
                        Pilot<br>Scale
                    </button>
                </div>
            </div>

            <!-- State Management -->
            <div class="parameter-section">
                <h3 class="section-title">
                    <span class="section-icon">💾</span>
                    Configuration Management
                </h3>
                <div class="state-controls">
                    <button class="state-btn" onclick="saveConfiguration()">
                        Save Config
                    </button>
                    <button class="state-btn" onclick="loadConfiguration()">
                        Load Config
                    </button>
                    <button class="state-btn" onclick="exportConfiguration()">
                        Export JSON
                    </button>
                </div>
                <div class="state-controls" style="margin-top: 10px;">
                    <button class="state-btn" onclick="resetConfiguration()">
                        Reset to Default
                    </button>
                    <button class="state-btn" onclick="toggleHistory()">
                        View History
                    </button>
                    <button class="state-btn" onclick="compareConfigurations()">
                        Compare
                    </button>
                </div>
            </div>

            <!-- Analysis Tools -->
            <div class="parameter-section advanced-param" style="display: none;">
                <h3 class="section-title">
                    <span class="section-icon">📊</span>
                    Analysis Tools
                </h3>
                <div class="state-controls">
                    <button class="state-btn" onclick="runOptimization()">
                        Optimize System
                    </button>
                    <button class="state-btn" onclick="showCharts()">
                        Performance Charts
                    </button>
                    <button class="state-btn" onclick="exportReport()">
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="performance-panel" class="glass-panel">
        <h2 style="font-size: 20px; margin-bottom: 20px; color: #00ff88;">Performance Metrics</h2>
        
        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">Power Output</span>
                <span class="metric-value" id="power-output">0.0<span class="metric-unit">mW</span></span>
            </div>
            <div class="performance-bar">
                <div class="performance-fill" id="power-bar" style="width: 0%;"></div>
            </div>
        </div>

        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">Power Density</span>
                <span class="metric-value" id="power-density">0<span class="metric-unit">mW/m²</span></span>
            </div>
            <div class="performance-bar">
                <div class="performance-fill" id="density-bar" style="width: 0%;"></div>
            </div>
        </div>

        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">Efficiency</span>
                <span class="metric-value" id="efficiency">0<span class="metric-unit">%</span></span>
            </div>
            <div class="performance-bar">
                <div class="performance-fill" id="efficiency-bar" style="width: 0%;"></div>
            </div>
        </div>

        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">Voltage</span>
                <span class="metric-value" id="voltage">0.0<span class="metric-unit">V</span></span>
            </div>
        </div>

        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">Current</span>
                <span class="metric-value" id="current">0.0<span class="metric-unit">mA</span></span>
            </div>
        </div>

        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">Internal Resistance</span>
                <span class="metric-value" id="resistance">0<span class="metric-unit">Ω</span></span>
            </div>
        </div>

        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">CO₂ Fixation Rate</span>
                <span class="metric-value" id="co2-fixation">0<span class="metric-unit">mg/L/h</span></span>
            </div>
        </div>

        <div class="performance-metric">
            <div class="metric-header">
                <span class="metric-label">Coulombic Efficiency</span>
                <span class="metric-value" id="coulombic-efficiency">0<span class="metric-unit">%</span></span>
            </div>
        </div>

        <div class="performance-metric advanced-param" style="display: none;">
            <div class="metric-header">
                <span class="metric-label">Energy Recovery</span>
                <span class="metric-value" id="energy-recovery">0<span class="metric-unit">%</span></span>
            </div>
        </div>

        <div class="performance-metric advanced-param" style="display: none;">
            <div class="metric-header">
                <span class="metric-label">Volumetric Power</span>
                <span class="metric-value" id="volumetric-power">0<span class="metric-unit">W/m³</span></span>
            </div>
        </div>
    </div>

    <div id="view-controls" class="glass-panel">
        <button class="control-btn" id="rotation-btn" onclick="toggleRotation()">Auto Rotate</button>
        <button class="control-btn" id="electron-btn" onclick="toggleElectronFlow()">Electron Flow</button>
        <button class="control-btn" onclick="changeView('micro')">Microscopic</button>
        <button class="control-btn" onclick="changeView('macro')">System View</button>
        <button class="control-btn" onclick="toggleLight()">Day/Night</button>
        <button class="control-btn" onclick="resetCamera()">Reset View</button>
    </div>

    <div id="charts-panel" class="glass-panel">
        <canvas id="performance-chart"></canvas>
    </div>

    <div id="history-panel" class="glass-panel">
        <h3 style="margin-bottom: 15px;">Configuration History</h3>
        <div id="history-list"></div>
    </div>

    <div class="error-message" id="error-message">
        <h3>Error</h3>
        <p id="error-text"></p>
        <button class="control-btn" onclick="hideError()">OK</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ==========================================
        // GLOBAL STATE MANAGEMENT
        // ==========================================
        
        const FuelCellDesigner = {
            // Core system state
            state: {
                scene: null,
                camera: null,
                renderer: null,
                clock: new THREE.Clock(),
                
                // 3D objects
                objects: {
                    hydrogelChamber: null,
                    anodeGroup: null,
                    cathodeGroup: null,
                    algaeGroups: {},
                    electrons: [],
                    electronPaths: [],
                    particleSystems: {}
                },
                
                // Animation state
                animation: {
                    isRotating: true,
                    showElectrons: true,
                    isDayTime: true,
                    frameId: null
                },
                
                // UI state
                ui: {
                    advancedMode: false,
                    currentTab: 'biological',
                    selectedMediators: ['none'],
                    history: [],
                    charts: {}
                }
            },
            
            // System parameters with comprehensive defaults
            parameters: {
                algae: {
                    type: 'mixed',
                    density: 5.0, // × 10⁶ cells/mL
                    volume: 100, // mL
                    growthPhase: 'exponential',
                    biofilm: 20 // %
                },
                electrodes: {
                    anodeMaterial: 'graphene',
                    cathodeMaterial: 'mxene',
                    area: 25, // cm²
                    separation: 2.0, // cm
                    surfaceModification: 'none'
                },
                separator: {
                    type: 'pem',
                    thickness: 0.18 // mm
                },
                environment: {
                    lightIntensity: 200, // μmol/m²/s
                    lightSpectrum: 'white',
                    temperature: 25, // °C
                    ph: 7.0,
                    co2: 5.0 // %
                },
                mediators: {
                    types: ['none'],
                    concentration: 0.1 // mM
                },
                medium: {
                    type: 'bg11',
                    nitrogen: 'nitrate',
                    phosphate: 1.0 // mM
                },
                electrical: {
                    externalResistance: 1000, // Ω
                    connectionType: 'single',
                    cellCount: 1
                },
                flow: {
                    operationMode: 'batch',
                    flowRate: 0, // mL/min
                    mixingSpeed: 100, // RPM
                    aerationRate: 0.5 // vvm
                },
                process: {
                    lightCycle: '16:8',
                    retentionTime: 24 // h
                },
                performance: {
                    power: 0,
                    powerDensity: 0,
                    efficiency: 0,
                    voltage: 0,
                    current: 0,
                    resistance: 0,
                    co2Fixation: 0,
                    coulombicEfficiency: 0,
                    energyRecovery: 0,
                    volumetricPower: 0
                }
            },
            
            // Material properties database
            database: {
                algae: {
                    chlorella: {
                        name: 'Chlorella vulgaris',
                        color: 0x00ff00,
                        efficiency: 0.12,
                        electronTransferRate: 2.3e8,
                        co2FixationRate: 45,
                        optimalPH: 7.0,
                        optimalTemp: 25,
                        growthRate: 0.8
                    },
                    spirulina: {
                        name: 'Spirulina platensis',
                        color: 0x00ffff,
                        efficiency: 0.10,
                        electronTransferRate: 1.8e8,
                        co2FixationRate: 38,
                        optimalPH: 8.5,
                        optimalTemp: 30,
                        growthRate: 0.6
                    },
                    scenedesmus: {
                        name: 'Scenedesmus obliquus',
                        color: 0x88ff00,
                        efficiency: 0.11,
                        electronTransferRate: 2.0e8,
                        co2FixationRate: 42,
                        optimalPH: 7.5,
                        optimalTemp: 27,
                        growthRate: 0.7
                    },
                    dunaliella: {
                        name: 'Dunaliella salina',
                        color: 0xff8800,
                        efficiency: 0.09,
                        electronTransferRate: 1.5e8,
                        co2FixationRate: 35,
                        optimalPH: 7.8,
                        optimalTemp: 28,
                        growthRate: 0.5
                    },
                    chlamydomonas: {
                        name: 'Chlamydomonas reinhardtii',
                        color: 0x00ff88,
                        efficiency: 0.13,
                        electronTransferRate: 2.5e8,
                        co2FixationRate: 48,
                        optimalPH: 7.2,
                        optimalTemp: 24,
                        growthRate: 0.9
                    },
                    synechocystis: {
                        name: 'Synechocystis sp.',
                        color: 0x0088ff,
                        efficiency: 0.14,
                        electronTransferRate: 2.7e8,
                        co2FixationRate: 52,
                        optimalPH: 7.5,
                        optimalTemp: 30,
                        growthRate: 0.85
                    },
                    anabaena: {
                        name: 'Anabaena variabilis',
                        color: 0x8800ff,
                        efficiency: 0.11,
                        electronTransferRate: 2.1e8,
                        co2FixationRate: 40,
                        optimalPH: 7.8,
                        optimalTemp: 28,
                        growthRate: 0.65
                    }
                },
                electrodes: {
                    anode: {
                        graphene: { conductivity: 0.96, cost: 100, surfaceArea: 2600, stability: 0.95 },
                        'carbon-cloth': { conductivity: 0.75, cost: 20, surfaceArea: 1500, stability: 0.85 },
                        'carbon-felt': { conductivity: 0.70, cost: 15, surfaceArea: 2000, stability: 0.80 },
                        graphite: { conductivity: 0.60, cost: 5, surfaceArea: 500, stability: 0.90 },
                        cnt: { conductivity: 0.95, cost: 150, surfaceArea: 3000, stability: 0.88 },
                        biochar: { conductivity: 0.50, cost: 3, surfaceArea: 1000, stability: 0.75 },
                        rgo: { conductivity: 0.85, cost: 80, surfaceArea: 2200, stability: 0.82 },
                        'carbon-paper': { conductivity: 0.72, cost: 25, surfaceArea: 1200, stability: 0.83 },
                        'carbon-brush': { conductivity: 0.68, cost: 30, surfaceArea: 2500, stability: 0.78 }
                    },
                    cathode: {
                        mxene: { conductivity: 0.98, cost: 200, oxygenReduction: 0.95, stability: 0.92 },
                        platinum: { conductivity: 0.99, cost: 1000, oxygenReduction: 0.99, stability: 0.98 },
                        'graphene-oxide': { conductivity: 0.80, cost: 80, oxygenReduction: 0.70, stability: 0.75 },
                        'carbon-cloth-pt': { conductivity: 0.85, cost: 300, oxygenReduction: 0.90, stability: 0.88 },
                        mno2: { conductivity: 0.65, cost: 30, oxygenReduction: 0.75, stability: 0.80 },
                        pani: { conductivity: 0.70, cost: 50, oxygenReduction: 0.72, stability: 0.70 },
                        mos2: { conductivity: 0.82, cost: 120, oxygenReduction: 0.85, stability: 0.85 },
                        co3o4: { conductivity: 0.75, cost: 90, oxygenReduction: 0.82, stability: 0.83 },
                        'nitrogen-carbon': { conductivity: 0.78, cost: 60, oxygenReduction: 0.80, stability: 0.86 }
                    }
                },
                mediators: {
                    none: { redoxPotential: 0, electronTransferRate: 1.0, toxicity: 0 },
                    'methylene-blue': { redoxPotential: 0.011, electronTransferRate: 1.8, toxicity: 0.2 },
                    'neutral-red': { redoxPotential: -0.325, electronTransferRate: 1.6, toxicity: 0.3 },
                    ferricyanide: { redoxPotential: 0.361, electronTransferRate: 2.2, toxicity: 0.5 },
                    quinone: { redoxPotential: 0.280, electronTransferRate: 1.9, toxicity: 0.4 },
                    riboflavin: { redoxPotential: -0.208, electronTransferRate: 1.5, toxicity: 0.1 }
                },
                separators: {
                    none: { protonConductivity: 1.0, cost: 0, resistance: 0.1 },
                    pem: { protonConductivity: 0.9, cost: 100, resistance: 0.5 },
                    'salt-bridge': { protonConductivity: 0.6, cost: 10, resistance: 2.0 },
                    ceramic: { protonConductivity: 0.7, cost: 50, resistance: 1.5 },
                    cellulose: { protonConductivity: 0.5, cost: 20, resistance: 2.5 },
                    agar: { protonConductivity: 0.4, cost: 5, resistance: 3.0 },
                    'glass-frit': { protonConductivity: 0.55, cost: 30, resistance: 2.2 }
                }
            },
            
            // Presets
            presets: {
                optimal: {
                    algae: { type: 'synechocystis', density: 10.0, volume: 500, growthPhase: 'exponential', biofilm: 40 },
                    electrodes: { anodeMaterial: 'cnt', cathodeMaterial: 'mxene', area: 100, separation: 1.5, surfaceModification: 'plasma' },
                    separator: { type: 'pem', thickness: 0.12 },
                    environment: { lightIntensity: 400, lightSpectrum: 'red-blue', temperature: 30, ph: 7.5, co2: 8 },
                    mediators: { types: ['methylene-blue'], concentration: 0.5 },
                    medium: { type: 'bg11', nitrogen: 'mixed', phosphate: 2.0 },
                    electrical: { externalResistance: 500, connectionType: 'single', cellCount: 1 },
                    flow: { operationMode: 'continuous', flowRate: 5, mixingSpeed: 200, aerationRate: 1.0 },
                    process: { lightCycle: '18:6', retentionTime: 48 }
                },
                lowcost: {
                    algae: { type: 'chlorella', density: 5.0, volume: 100, growthPhase: 'exponential', biofilm: 20 },
                    electrodes: { anodeMaterial: 'biochar', cathodeMaterial: 'mno2', area: 25, separation: 2.0, surfaceModification: 'none' },
                    separator: { type: 'salt-bridge', thickness: 0.5 },
                    environment: { lightIntensity: 150, lightSpectrum: 'white', temperature: 25, ph: 7.0, co2: 3 },
                    mediators: { types: ['none'], concentration: 0 },
                    medium: { type: 'bold', nitrogen: 'nitrate', phosphate: 0.5 },
                    electrical: { externalResistance: 1000, connectionType: 'single', cellCount: 1 },
                    flow: { operationMode: 'batch', flowRate: 0, mixingSpeed: 50, aerationRate: 0.2 },
                    process: { lightCycle: '12:12', retentionTime: 24 }
                },
                highpower: {
                    algae: { type: 'mixed', density: 20.0, volume: 1000, growthPhase: 'exponential', biofilm: 60 },
                    electrodes: { anodeMaterial: 'graphene', cathodeMaterial: 'platinum', area: 200, separation: 1.0, surfaceModification: 'metal-nanoparticles' },
                    separator: { type: 'pem', thickness: 0.1 },
                    environment: { lightIntensity: 600, lightSpectrum: 'full-spectrum', temperature: 32, ph: 7.8, co2: 10 },
                    mediators: { types: ['ferricyanide', 'methylene-blue'], concentration: 1.0 },
                    medium: { type: 'f2', nitrogen: 'mixed', phosphate: 3.0 },
                    electrical: { externalResistance: 100, connectionType: 'parallel', cellCount: 4 },
                    flow: { operationMode: 'continuous', flowRate: 20, mixingSpeed: 300, aerationRate: 2.0 },
                    process: { lightCycle: 'continuous', retentionTime: 72 }
                },
                stable: {
                    algae: { type: 'spirulina', density: 8.0, volume: 200, growthPhase: 'stationary', biofilm: 30 },
                    electrodes: { anodeMaterial: 'carbon-cloth', cathodeMaterial: 'carbon-cloth-pt', area: 50, separation: 2.5, surfaceModification: 'polymer' },
                    separator: { type: 'ceramic', thickness: 0.3 },
                    environment: { lightIntensity: 200, lightSpectrum: 'white', temperature: 25, ph: 8.0, co2: 5 },
                    mediators: { types: ['riboflavin'], concentration: 0.2 },
                    medium: { type: 'zarrouk', nitrogen: 'nitrate', phosphate: 1.0 },
                    electrical: { externalResistance: 800, connectionType: 'single', cellCount: 1 },
                    flow: { operationMode: 'batch', flowRate: 0, mixingSpeed: 100, aerationRate: 0.5 },
                    process: { lightCycle: '16:8', retentionTime: 36 }
                },
                research: {
                    algae: { type: 'chlamydomonas', density: 15.0, volume: 250, growthPhase: 'exponential', biofilm: 10 },
                    electrodes: { anodeMaterial: 'rgo', cathodeMaterial: 'mos2', area: 75, separation: 1.8, surfaceModification: 'enzyme' },
                    separator: { type: 'pem', thickness: 0.15 },
                    environment: { lightIntensity: 350, lightSpectrum: 'red-blue', temperature: 24, ph: 7.2, co2: 7 },
                    mediators: { types: ['quinone', 'neutral-red'], concentration: 0.3 },
                    medium: { type: 'tris', nitrogen: 'ammonium', phosphate: 1.5 },
                    electrical: { externalResistance: 600, connectionType: 'series', cellCount: 2 },
                    flow: { operationMode: 'fed-batch', flowRate: 2, mixingSpeed: 150, aerationRate: 0.8 },
                    process: { lightCycle: '16:8', retentionTime: 48 }
                },
                pilot: {
                    algae: { type: 'scenedesmus', density: 12.0, volume: 2000, growthPhase: 'exponential', biofilm: 35 },
                    electrodes: { anodeMaterial: 'carbon-felt', cathodeMaterial: 'nitrogen-carbon', area: 150, separation: 3.0, surfaceModification: 'acid' },
                    separator: { type: 'cellulose', thickness: 0.4 },
                    environment: { lightIntensity: 250, lightSpectrum: 'white', temperature: 27, ph: 7.5, co2: 6 },
                    mediators: { types: ['none'], concentration: 0 },
                    medium: { type: 'bg11', nitrogen: 'mixed', phosphate: 1.2 },
                    electrical: { externalResistance: 1200, connectionType: 'series-parallel', cellCount: 6 },
                    flow: { operationMode: 'semi-continuous', flowRate: 10, mixingSpeed: 120, aerationRate: 0.6 },
                    process: { lightCycle: '16:8', retentionTime: 60 }
                }
            }
        };

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        function init() {
            try {
                // Initialize Three.js scene
                initScene();
                
                // Initialize controls
                initControls();
                
                // Initialize UI
                initUI();
                
                // Create initial system
                createSystem();
                
                // Calculate initial performance
                calculatePerformance();
                
                // Start animation loop
                animate();
                
                // Hide loading screen
                hideLoading();
                
                // Load saved state if exists
                loadLastState();
                
            } catch (error) {
                handleError('Initialization failed', error);
            }
        }

        function initScene() {
            const state = FuelCellDesigner.state;
            
            // Scene setup
            state.scene = new THREE.Scene();
            state.scene.background = new THREE.Color(0x000000);
            state.scene.fog = new THREE.FogExp2(0x000511, 0.015);

            // Camera
            state.camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            state.camera.position.set(0, 8, 15);
            state.camera.lookAt(0, 0, 0);

            // Renderer
            state.renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true,
                powerPreference: "high-performance",
                precision: "highp"
            });
            state.renderer.setSize(window.innerWidth, window.innerHeight);
            state.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            state.renderer.shadowMap.enabled = true;
            state.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            state.renderer.toneMapping = THREE.ACESFilmicToneMapping;
            state.renderer.toneMappingExposure = 1.5;
            state.renderer.outputEncoding = THREE.sRGBEncoding;
            
            document.getElementById('canvas-container').appendChild(state.renderer.domElement);

            // Lighting
            setupLighting();
        }

        function setupLighting() {
            const scene = FuelCellDesigner.state.scene;
            
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x001122, 0.4);
            scene.add(ambientLight);

            // Main directional light
            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8);
            mainLight.position.set(10, 15, 10);
            mainLight.castShadow = true;
            mainLight.shadow.camera.near = 0.1;
            mainLight.shadow.camera.far = 50;
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            scene.add(mainLight);

            // Bio light
            const bioLight = new THREE.PointLight(0x00ff00, 0.6, 25);
            bioLight.position.set(0, 10, 0);
            scene.add(bioLight);

            // Store lights for later manipulation
            FuelCellDesigner.state.objects.lights = {
                ambient: ambientLight,
                main: mainLight,
                bio: bioLight
            };
        }

        function initControls() {
            const state = FuelCellDesigner.state;
            const renderer = state.renderer;
            
            let mouseX = 0, mouseY = 0;
            let isMouseDown = false;
            let touchStartDistance = 0;

            // Mouse controls
            renderer.domElement.addEventListener('mousedown', (e) => {
                if (e.button === 0) isMouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            renderer.domElement.addEventListener('mousemove', (e) => {
                if (isMouseDown) {
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    
                    const rotationSpeed = 0.01;
                    state.camera.position.x = state.camera.position.x * Math.cos(deltaX * rotationSpeed) - 
                                            state.camera.position.z * Math.sin(deltaX * rotationSpeed);
                    state.camera.position.z = state.camera.position.x * Math.sin(deltaX * rotationSpeed) + 
                                            state.camera.position.z * Math.cos(deltaX * rotationSpeed);
                    
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                    state.camera.lookAt(0, 0, 0);
                }
            });

            renderer.domElement.addEventListener('mouseup', () => {
                isMouseDown = false;
            });

            renderer.domElement.addEventListener('wheel', (e) => {
                const delta = e.deltaY * 0.01;
                const distance = state.camera.position.length();
                const newDistance = Math.max(8, Math.min(25, distance + delta));
                state.camera.position.normalize().multiplyScalar(newDistance);
            });

            // Touch controls
            renderer.domElement.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    touchStartDistance = Math.sqrt(dx * dx + dy * dy);
                }
            });

            renderer.domElement.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const scale = distance / touchStartDistance;
                    const newDistance = Math.max(8, Math.min(25, state.camera.position.length() / scale));
                    state.camera.position.normalize().multiplyScalar(newDistance);
                    touchStartDistance = distance;
                }
            });

            // Window resize
            window.addEventListener('resize', () => {
                state.camera.aspect = window.innerWidth / window.innerHeight;
                state.camera.updateProjectionMatrix();
                state.renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function initUI() {
            // Initialize all UI elements
            updateAllDisplays();
            
            // Set up event delegation for better performance
            document.getElementById('control-panel').addEventListener('change', handleParameterChange);
            document.getElementById('control-panel').addEventListener('input', handleParameterInput);
        }

        // ==========================================
        // SYSTEM CREATION
        // ==========================================
        
        function createSystem() {
            const objects = FuelCellDesigner.state.objects;
            const scene = FuelCellDesigner.state.scene;
            
            // Clear existing objects
            clearScene();
            
            // Create components
            createHydrogelChamber();
            createElectrodes();
            createMicroalgae();
            createElectronFlow();
            createParticleSystems();
            
            // Update scene
            scene.add(objects.hydrogelChamber);
            scene.add(objects.anodeGroup);
            scene.add(objects.cathodeGroup);
            
            Object.values(objects.algaeGroups).forEach(group => {
                scene.add(group);
            });
        }

        function clearScene() {
            const objects = FuelCellDesigner.state.objects;
            const scene = FuelCellDesigner.state.scene;
            
            // Remove all dynamic objects
            ['hydrogelChamber', 'anodeGroup', 'cathodeGroup'].forEach(key => {
                if (objects[key]) {
                    scene.remove(objects[key]);
                    disposeObject(objects[key]);
                    objects[key] = null;
                }
            });
            
            // Clear algae groups
            Object.values(objects.algaeGroups).forEach(group => {
                scene.remove(group);
                disposeObject(group);
            });
            objects.algaeGroups = {};
            
            // Clear electrons
            objects.electrons.forEach(electron => {
                scene.remove(electron);
                disposeObject(electron);
            });
            objects.electrons = [];
            objects.electronPaths = [];
        }

        function disposeObject(obj) {
            if (obj.geometry) obj.geometry.dispose();
            if (obj.material) {
                if (Array.isArray(obj.material)) {
                    obj.material.forEach(mat => mat.dispose());
                } else {
                    obj.material.dispose();
                }
            }
            if (obj.children) {
                obj.children.forEach(child => disposeObject(child));
            }
        }

        function createHydrogelChamber() {
            const params = FuelCellDesigner.parameters;
            const objects = FuelCellDesigner.state.objects;
            
            const volume = params.algae.volume;
            const scale = Math.cbrt(volume / 100);
            
            const geometry = new THREE.BoxGeometry(8 * scale, 4 * scale, 3 * scale);
            const material = new THREE.MeshPhysicalMaterial({
                color: 0x00ffaa,
                metalness: 0,
                roughness: 0.1,
                transmission: 0.95,
                transparent: true,
                opacity: 0.25,
                clearcoat: 1,
                clearcoatRoughness: 0,
                ior: 1.33
            });
            
            objects.hydrogelChamber = new THREE.Mesh(geometry, material);
            objects.hydrogelChamber.castShadow = true;
            objects.hydrogelChamber.receiveShadow = true;
            
            // Add volume indicator
            const edges = new THREE.EdgesGeometry(geometry);
            const edgeMaterial = new THREE.LineBasicMaterial({ 
                color: 0x00ff88,
                transparent: true,
                opacity: 0.3
            });
            const edgeLines = new THREE.LineSegments(edges, edgeMaterial);
            objects.hydrogelChamber.add(edgeLines);
        }

        function createElectrodes() {
            const params = FuelCellDesigner.parameters;
            const objects = FuelCellDesigner.state.objects;
            const database = FuelCellDesigner.database;
            
            const area = params.electrodes.area;
            const separation = params.electrodes.separation;
            const scale = Math.sqrt(area / 25);
            
            // Create anode
            objects.anodeGroup = new THREE.Group();
            const anodeMaterial = params.electrodes.anodeMaterial;
            const anodeProps = database.electrodes.anode[anodeMaterial];
            
            createElectrodeGeometry(objects.anodeGroup, anodeMaterial, scale, anodeProps);
            objects.anodeGroup.position.set(-4 - separation/2, 0, 0);
            
            // Create cathode
            objects.cathodeGroup = new THREE.Group();
            const cathodeMaterial = params.electrodes.cathodeMaterial;
            const cathodeProps = database.electrodes.cathode[cathodeMaterial];
            
            createElectrodeGeometry(objects.cathodeGroup, cathodeMaterial, scale, cathodeProps);
            objects.cathodeGroup.position.set(4 + separation/2, 0, 0);
            
            // Add surface modification effects
            if (params.electrodes.surfaceModification !== 'none') {
                applySurfaceModification(objects.anodeGroup, params.electrodes.surfaceModification);
                applySurfaceModification(objects.cathodeGroup, params.electrodes.surfaceModification);
            }
        }

        function createElectrodeGeometry(group, materialType, scale, props) {
            // Base electrode
            const geometry = new THREE.BoxGeometry(4 * scale, 0.2 * scale, 3.5 * scale);
            const material = new THREE.MeshPhysicalMaterial({
                color: materialType.includes('graphene') ? 0x1a1a1a : 0x333333,
                metalness: props.conductivity,
                roughness: 1 - props.conductivity,
                clearcoat: 0.5,
                clearcoatRoughness: 0.1
            });
            
            const electrode = new THREE.Mesh(geometry, material);
            electrode.castShadow = true;
            electrode.receiveShadow = true;
            group.add(electrode);
            
            // Add specific material features
            if (materialType === 'graphene' || materialType === 'cnt') {
                addNanostructure(group, scale);
            } else if (materialType === 'mxene') {
                addLayeredStructure(group, scale);
            } else if (materialType.includes('cloth') || materialType.includes('felt')) {
                addFiberTexture(group, scale);
            }
        }

        function addNanostructure(group, scale) {
            const particleCount = 100;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 4 * scale;
                positions[i + 1] = Math.random() * 0.1;
                positions[i + 2] = (Math.random() - 0.5) * 3.5 * scale;
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const material = new THREE.PointsMaterial({
                color: 0x333333,
                size: 0.05,
                transparent: true,
                opacity: 0.8
            });
            
            const particles = new THREE.Points(geometry, material);
            group.add(particles);
        }

        function addLayeredStructure(group, scale) {
            for (let i = 0; i < 5; i++) {
                const layerGeometry = new THREE.PlaneGeometry(4 * scale, 3.5 * scale);
                const layerMaterial = new THREE.MeshPhysicalMaterial({
                    color: 0xff00ff,
                    metalness: 0.9,
                    roughness: 0.1,
                    transparent: true,
                    opacity: 0.3,
                    side: THREE.DoubleSide
                });
                
                const layer = new THREE.Mesh(layerGeometry, layerMaterial);
                layer.position.y = 0.1 + i * 0.05;
                layer.rotation.x = -Math.PI / 2;
                group.add(layer);
            }
        }

        function addFiberTexture(group, scale) {
            const fiberCount = 50;
            for (let i = 0; i < fiberCount; i++) {
                const curve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(
                        (Math.random() - 0.5) * 4 * scale,
                        0.1,
                        (Math.random() - 0.5) * 3.5 * scale
                    ),
                    new THREE.Vector3(
                        (Math.random() - 0.5) * 4 * scale,
                        0.15,
                        (Math.random() - 0.5) * 3.5 * scale
                    )
                ]);
                
                const geometry = new THREE.TubeGeometry(curve, 10, 0.01, 8, false);
                const material = new THREE.MeshStandardMaterial({
                    color: 0x222222,
                    roughness: 0.8
                });
                
                const fiber = new THREE.Mesh(geometry, material);
                group.add(fiber);
            }
        }

        function applySurfaceModification(group, modificationType) {
            switch (modificationType) {
                case 'plasma':
                    // Add plasma treatment effect
                    const plasmaGlow = new THREE.Mesh(
                        new THREE.BoxGeometry(4.1, 0.3, 3.6),
                        new THREE.MeshBasicMaterial({
                            color: 0x00ffff,
                            transparent: true,
                            opacity: 0.1
                        })
                    );
                    group.add(plasmaGlow);
                    break;
                    
                case 'metal-nanoparticles':
                    // Add metal nanoparticles
                    for (let i = 0; i < 50; i++) {
                        const particle = new THREE.Mesh(
                            new THREE.SphereGeometry(0.02, 8, 8),
                            new THREE.MeshPhysicalMaterial({
                                color: 0xffaa00,
                                metalness: 0.99,
                                roughness: 0.01,
                                emissive: 0xffaa00,
                                emissiveIntensity: 0.2
                            })
                        );
                        particle.position.set(
                            (Math.random() - 0.5) * 4,
                            0.15,
                            (Math.random() - 0.5) * 3.5
                        );
                        group.add(particle);
                    }
                    break;
            }
        }

        function createMicroalgae() {
            const params = FuelCellDesigner.parameters;
            const objects = FuelCellDesigner.state.objects;
            const database = FuelCellDesigner.database;
            
            const density = params.algae.density;
            const algaeCount = Math.floor(density * 10);
            
            // Clear existing algae groups
            Object.keys(objects.algaeGroups).forEach(key => {
                if (objects.algaeGroups[key]) {
                    FuelCellDesigner.state.scene.remove(objects.algaeGroups[key]);
                }
            });
            objects.algaeGroups = {};
            
            // Create algae based on type
            if (params.algae.type === 'mixed') {
                objects.algaeGroups.chlorella = createAlgaeSpecies('chlorella', algaeCount / 2);
                objects.algaeGroups.spirulina = createAlgaeSpecies('spirulina', algaeCount / 2);
            } else {
                objects.algaeGroups[params.algae.type] = createAlgaeSpecies(params.algae.type, algaeCount);
            }
        }

        function createAlgaeSpecies(species, count) {
            const group = new THREE.Group();
            const props = FuelCellDesigner.database.algae[species];
            const biofilmRatio = FuelCellDesigner.parameters.algae.biofilm / 100;
            
            for (let i = 0; i < count; i++) {
                const isBiofilm = Math.random() < biofilmRatio;
                const algae = createSingleAlgae(species, props, isBiofilm);
                
                if (isBiofilm) {
                    // Position on electrode surfaces
                    const side = Math.random() < 0.5 ? -4 : 4;
                    algae.position.set(
                        side + (Math.random() - 0.5) * 0.5,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 1.5
                    );
                    algae.userData.velocity.multiplyScalar(0.1); // Slower movement
                } else {
                    // Free-floating
                    algae.position.set(
                        (Math.random() - 0.5) * 6,
                        (Math.random() - 0.5) * 2.5,
                        (Math.random() - 0.5) * 1.5
                    );
                }
                
                group.add(algae);
            }
            
            return group;
        }

        function createSingleAlgae(species, props, isBiofilm) {
            const algae = new THREE.Group();
            
            // Different algae morphologies
            switch (species) {
                case 'chlorella':
                case 'dunaliella':
                case 'chlamydomonas':
                    // Spherical cells
                    const radius = 0.1 + Math.random() * 0.05;
                    const cell = new THREE.Mesh(
                        new THREE.SphereGeometry(radius, 24, 24),
                        new THREE.MeshPhysicalMaterial({
                            color: props.color,
                            metalness: 0,
                            roughness: 0.7,
                            clearcoat: 1,
                            clearcoatRoughness: 0.2,
                            transmission: 0.5,
                            transparent: true,
                            opacity: 0.8,
                            emissive: props.color,
                            emissiveIntensity: 0.05
                        })
                    );
                    algae.add(cell);
                    
                    // Add chloroplast
                    const chloroplast = new THREE.Mesh(
                        new THREE.SphereGeometry(radius * 0.7, 16, 16),
                        new THREE.MeshStandardMaterial({
                            color: 0x00aa00,
                            emissive: props.color,
                            emissiveIntensity: 0.2
                        })
                    );
                    chloroplast.position.x = radius * 0.2;
                    algae.add(chloroplast);
                    break;
                    
                case 'spirulina':
                case 'anabaena':
                    // Spiral/filamentous
                    const coils = 3 + Math.random() * 2;
                    const points = [];
                    for (let j = 0; j <= coils * 30; j++) {
                        const t = j / (coils * 30);
                        const angle = t * Math.PI * 2 * coils;
                        const rad = 0.08;
                        points.push(new THREE.Vector3(
                            Math.cos(angle) * rad,
                            t * 0.5 - 0.25,
                            Math.sin(angle) * rad
                        ));
                    }
                    
                    const curve = new THREE.CatmullRomCurve3(points);
                    const spiral = new THREE.Mesh(
                        new THREE.TubeGeometry(curve, 100, 0.025, 12, false),
                        new THREE.MeshPhysicalMaterial({
                            color: props.color,
                            metalness: 0,
                            roughness: 0.4,
                            clearcoat: 1,
                            emissive: props.color,
                            emissiveIntensity: 0.15
                        })
                    );
                    algae.add(spiral);
                    break;
                    
                case 'scenedesmus':
                    // Colonial (4-8 cells)
                    const cellCount = 4 + Math.floor(Math.random() * 4);
                    for (let j = 0; j < cellCount; j++) {
                        const sceneCell = new THREE.Mesh(
                            new THREE.SphereGeometry(0.08, 16, 16),
                            new THREE.MeshPhysicalMaterial({
                                color: props.color,
                                metalness: 0,
                                roughness: 0.6,
                                transmission: 0.4,
                                transparent: true,
                                opacity: 0.8,
                                emissive: props.color,
                                emissiveIntensity: 0.1
                            })
                        );
                        sceneCell.position.x = j * 0.12 - (cellCount - 1) * 0.06;
                        algae.add(sceneCell);
                    }
                    break;
                    
                case 'synechocystis':
                    // Small coccoid cyanobacteria
                    const synCell = new THREE.Mesh(
                        new THREE.SphereGeometry(0.06, 16, 16),
                        new THREE.MeshPhysicalMaterial({
                            color: props.color,
                            metalness: 0,
                            roughness: 0.5,
                            emissive: props.color,
                            emissiveIntensity: 0.2
                        })
                    );
                    algae.add(synCell);
                    
                    // Add thylakoid-like structures
                    for (let k = 0; k < 3; k++) {
                        const thylakoid = new THREE.Mesh(
                            new THREE.TorusGeometry(0.03, 0.005, 8, 16),
                            new THREE.MeshBasicMaterial({
                                color: props.color,
                                transparent: true,
                                opacity: 0.5
                            })
                        );
                        thylakoid.position.y = (k - 1) * 0.02;
                        thylakoid.rotation.x = Math.PI / 2;
                        algae.add(thylakoid);
                    }
                    break;
            }
            
            // Add growth phase effects
            const growthPhase = FuelCellDesigner.parameters.algae.growthPhase;
            let scaleFactor = 1;
            switch (growthPhase) {
                case 'lag': scaleFactor = 0.7; break;
                case 'exponential': scaleFactor = 1.0; break;
                case 'stationary': scaleFactor = 1.1; break;
                case 'decline': scaleFactor = 0.9; break;
            }
            algae.scale.setScalar(scaleFactor);
            
            // Set movement properties
            algae.userData = {
                velocity: new THREE.Vector3(
                    (Math.random() - 0.5) * 0.008,
                    (Math.random() - 0.5) * 0.008,
                    (Math.random() - 0.5) * 0.008
                ),
                type: species,
                isBiofilm: isBiofilm,
                growthRate: props.growthRate * (isBiofilm ? 0.5 : 1)
            };
            
            return algae;
        }

        function createElectronFlow() {
            const params = FuelCellDesigner.parameters;
            const objects = FuelCellDesigner.state.objects;
            const scene = FuelCellDesigner.state.scene;
            
            // Clear existing electrons
            objects.electrons.forEach(e => {
                scene.remove(e);
                disposeObject(e);
            });
            objects.electrons = [];
            objects.electronPaths = [];
            
            // Calculate electron count based on current
            const electronCount = Math.floor(params.algae.density * params.electrodes.area / 5);
            
            // Create electron paths
            for (let i = 0; i < 5; i++) {
                const path = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(
                        (Math.random() - 0.5) * 4,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 1
                    ),
                    new THREE.Vector3(-2, (Math.random() - 0.5) * 2, (Math.random() - 0.5)),
                    new THREE.Vector3(0, (Math.random() - 0.5) * 2, (Math.random() - 0.5)),
                    new THREE.Vector3(2, (Math.random() - 0.5) * 2, (Math.random() - 0.5)),
                    new THREE.Vector3(
                        4 + params.electrodes.separation/2,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 1
                    )
                ]);
                
                objects.electronPaths.push(path);
                
                // Create electrons on path
                for (let j = 0; j < electronCount / 5; j++) {
                    const electron = createElectron();
                    electron.userData = {
                        path: path,
                        progress: j / (electronCount / 5),
                        speed: 0.002 + Math.random() * 0.002
                    };
                    
                    objects.electrons.push(electron);
                    scene.add(electron);
                }
            }
            
            // Mediator effects
            const mediatorBoost = params.mediators.types.reduce((acc, type) => {
                const mediator = FuelCellDesigner.database.mediators[type];
                return acc * (mediator ? mediator.electronTransferRate : 1);
            }, 1);
            
            objects.electrons.forEach(e => {
                e.userData.speed *= mediatorBoost;
            });
        }

        function createElectron() {
            const electron = new THREE.Group();
            
            // Core
            const core = new THREE.Mesh(
                new THREE.SphereGeometry(0.02, 12, 12),
                new THREE.MeshBasicMaterial({
                    color: 0xffd700,
                    emissive: 0xffd700
                })
            );
            electron.add(core);
            
            // Inner glow
            const innerGlow = new THREE.Mesh(
                new THREE.SphereGeometry(0.03, 8, 8),
                new THREE.MeshBasicMaterial({
                    color: 0xffff00,
                    transparent: true,
                    opacity: 0.6
                })
            );
            electron.add(innerGlow);
            
            // Outer glow
            const outerGlow = new THREE.Mesh(
                new THREE.SphereGeometry(0.05, 8, 8),
                new THREE.MeshBasicMaterial({
                    color: 0xffd700,
                    transparent: true,
                    opacity: 0.2
                })
            );
            electron.add(outerGlow);
            
            return electron;
        }

        function createParticleSystems() {
            const params = FuelCellDesigner.parameters;
            const objects = FuelCellDesigner.state.objects;
            
            // Create different particle systems based on parameters
            
            // CO2 bubbles
            if (params.environment.co2 > 0) {
                createCO2Bubbles();
            }
            
            // Nutrient particles
            if (params.flow.operationMode !== 'batch') {
                createNutrientFlow();
            }
            
            // Mediator visualization
            if (params.mediators.types.length > 0 && params.mediators.types[0] !== 'none') {
                createMediatorParticles();
            }
        }

        function createCO2Bubbles() {
            const objects = FuelCellDesigner.state.objects;
            const scene = FuelCellDesigner.state.scene;
            const co2Level = FuelCellDesigner.parameters.environment.co2;
            
            const bubbleGroup = new THREE.Group();
            const bubbleCount = Math.floor(co2Level * 10);
            
            for (let i = 0; i < bubbleCount; i++) {
                const bubble = new THREE.Mesh(
                    new THREE.SphereGeometry(0.03 + Math.random() * 0.02, 8, 8),
                    new THREE.MeshPhysicalMaterial({
                        color: 0xffffff,
                        metalness: 0,
                        roughness: 0,
                        transmission: 0.95,
                        transparent: true,
                        opacity: 0.3
                    })
                );
                
                bubble.position.set(
                    (Math.random() - 0.5) * 6,
                    -2,
                    (Math.random() - 0.5) * 2
                );
                
                bubble.userData = {
                    velocity: 0.01 + Math.random() * 0.02,
                    wobble: Math.random() * Math.PI * 2
                };
                
                bubbleGroup.add(bubble);
            }
            
            objects.particleSystems.co2Bubbles = bubbleGroup;
            scene.add(bubbleGroup);
        }

        function createNutrientFlow() {
            // Implementation for nutrient particle visualization
            // Similar to CO2 bubbles but with different appearance and behavior
        }

        function createMediatorParticles() {
            // Implementation for mediator molecule visualization
            // Color-coded based on mediator type
        }

        // ==========================================
        // PERFORMANCE CALCULATIONS
        // ==========================================
        
        function calculatePerformance() {
            const params = FuelCellDesigner.parameters;
            const database = FuelCellDesigner.database;
            
            // Get material properties
            const algaeProps = getAlgaeProperties();
            const anodeProps = database.electrodes.anode[params.electrodes.anodeMaterial];
            const cathodeProps = database.electrodes.cathode[params.electrodes.cathodeMaterial];
            const separatorProps = database.separators[params.separator.type];
            
            // Environmental factors
            const envFactors = calculateEnvironmentalFactors(algaeProps);
            
            // Electrical calculations
            const electrical = calculateElectricalParameters(algaeProps, anodeProps, cathodeProps, 
                                                           separatorProps, envFactors);
            
            // Update performance object
            params.performance = {
                power: electrical.power,
                powerDensity: electrical.powerDensity,
                efficiency: electrical.efficiency,
                voltage: electrical.voltage,
                current: electrical.current,
                resistance: electrical.resistance,
                co2Fixation: calculateCO2Fixation(algaeProps, envFactors),
                coulombicEfficiency: electrical.coulombicEfficiency,
                energyRecovery: electrical.energyRecovery,
                volumetricPower: electrical.volumetricPower
            };
            
            // Update displays
            updatePerformanceDisplay();
            
            // Add to history
            addToHistory();
        }

        function getAlgaeProperties() {
            const params = FuelCellDesigner.parameters;
            const database = FuelCellDesigner.database;
            
            if (params.algae.type === 'mixed') {
                // Average properties for mixed culture
                const chlorella = database.algae.chlorella;
                const spirulina = database.algae.spirulina;
                return {
                    efficiency: (chlorella.efficiency + spirulina.efficiency) / 2,
                    electronTransferRate: (chlorella.electronTransferRate + spirulina.electronTransferRate) / 2,
                    co2FixationRate: (chlorella.co2FixationRate + spirulina.co2FixationRate) / 2,
                    optimalPH: (chlorella.optimalPH + spirulina.optimalPH) / 2,
                    optimalTemp: (chlorella.optimalTemp + spirulina.optimalTemp) / 2,
                    growthRate: (chlorella.growthRate + spirulina.growthRate) / 2
                };
            } else {
                return database.algae[params.algae.type];
            }
        }

        function calculateEnvironmentalFactors(algaeProps) {
            const params = FuelCellDesigner.parameters;
            
            // Light factor (Michaelis-Menten kinetics)
            const Ik = 150; // Half-saturation constant
            const lightFactor = params.environment.lightIntensity / (params.environment.lightIntensity + Ik);
            
            // Temperature factor (Cardinal temperature model)
            const temp = params.environment.temperature;
            const optTemp = algaeProps.optimalTemp;
            const tempRange = 15; // Temperature range
            const tempFactor = Math.exp(-Math.pow((temp - optTemp) / tempRange, 2));
            
            // pH factor
            const ph = params.environment.ph;
            const optPH = algaeProps.optimalPH;
            const phRange = 1.5;
            const phFactor = Math.exp(-Math.pow((ph - optPH) / phRange, 2));
            
            // CO2 factor
            const co2 = params.environment.co2;
            const co2Factor = Math.min(co2 / 5, 1) * (1 + Math.log10(co2 + 1) / 2);
            
            // Growth phase factor
            const growthFactors = {
                lag: 0.5,
                exponential: 1.0,
                stationary: 0.8,
                decline: 0.4
            };
            const growthFactor = growthFactors[params.algae.growthPhase];
            
            // Light spectrum factor
            const spectrumFactors = {
                white: 1.0,
                'red-blue': 1.2,
                'full-spectrum': 1.1,
                red: 0.8,
                blue: 0.7,
                green: 0.4
            };
            const spectrumFactor = spectrumFactors[params.environment.lightSpectrum];
            
            return {
                light: lightFactor * spectrumFactor,
                temperature: tempFactor,
                ph: phFactor,
                co2: co2Factor,
                growth: growthFactor,
                combined: lightFactor * tempFactor * phFactor * co2Factor * growthFactor * spectrumFactor
            };
        }

        function calculateElectricalParameters(algaeProps, anodeProps, cathodeProps, separatorProps, envFactors) {
            const params = FuelCellDesigner.parameters;
            
            // Surface area in m²
            const area = params.electrodes.area / 10000;
            
            // Cell density effect
            const densityFactor = Math.log10(params.algae.density + 1) / 2;
            
            // Biofilm effect
            const biofilmBoost = 1 + (params.algae.biofilm / 100) * 0.5;
            
            // Mediator effect
            const mediatorBoost = params.mediators.types.reduce((acc, type) => {
                const mediator = FuelCellDesigner.database.mediators[type];
                return acc * (mediator ? mediator.electronTransferRate : 1);
            }, 1);
            
            // Calculate open circuit voltage (OCV)
            const standardPotential = 0.8; // V
            const nernstCorrection = (8.314 * (273.15 + params.environment.temperature)) / (96485 * 2) * 
                                   Math.log(params.algae.density * envFactors.combined);
            const ocv = standardPotential + nernstCorrection;
            
            // Internal resistance components
            const electrodeResistance = params.electrodes.separation / 
                                      (anodeProps.conductivity * cathodeProps.conductivity * area * 10);
            const solutionResistance = calculateSolutionResistance();
            const membraneResistance = separatorProps.resistance * (params.separator.thickness / 0.18);
            const chargeTransferResistance = 1 / (algaeProps.electronTransferRate * 1e-11 * 
                                                 params.algae.density * area * biofilmBoost * mediatorBoost);
            
            const internalResistance = electrodeResistance + solutionResistance + 
                                     membraneResistance + chargeTransferResistance;
            
            // Current calculation
            const totalResistance = internalResistance + params.electrical.externalResistance;
            const current = (ocv / totalResistance) * 1000; // mA
            
            // Actual voltage under load
            const voltage = ocv - (current / 1000) * internalResistance;
            
            // Power calculations
            const power = voltage * current; // mW
            const powerDensity = power / area; // mW/m²
            const volumetricPower = power / (params.algae.volume / 1000); // W/m³
            
            // Efficiency calculations
            const inputPower = params.environment.lightIntensity * area * 0.2; // W (assuming 20% of light is PAR)
            const energyEfficiency = (power / (inputPower * 1000)) * 100;
            
            // Coulombic efficiency
            const theoreticalCurrent = algaeProps.electronTransferRate * params.algae.density * 
                                     area * 1.6e-19 * 1000; // mA
            const coulombicEfficiency = (current / theoreticalCurrent) * 100;
            
            // Energy recovery (for wastewater treatment)
            const cod = 500; // mg/L (assumed COD)
            const codRemoval = 0.8; // 80% removal
            const energyContent = cod * codRemoval * params.algae.volume / 1000 * 3.86; // kJ
            const energyRecovery = (power * 3.6 / energyContent) * 100;
            
            // Adjust for connection type
            let finalVoltage = voltage;
            let finalCurrent = current;
            let finalPower = power;
            
            switch (params.electrical.connectionType) {
                case 'series':
                    finalVoltage = voltage * params.electrical.cellCount;
                    finalCurrent = current;
                    finalPower = finalVoltage * finalCurrent;
                    break;
                case 'parallel':
                    finalVoltage = voltage;
                    finalCurrent = current * params.electrical.cellCount;
                    finalPower = finalVoltage * finalCurrent;
                    break;
                case 'series-parallel':
                    const seriesCount = Math.ceil(params.electrical.cellCount / 2);
                    const parallelCount = Math.floor(params.electrical.cellCount / 2);
                    finalVoltage = voltage * seriesCount;
                    finalCurrent = current * parallelCount;
                    finalPower = finalVoltage * finalCurrent;
                    break;
            }
            
            return {
                voltage: finalVoltage.toFixed(3),
                current: finalCurrent.toFixed(2),
                power: finalPower.toFixed(2),
                powerDensity: (finalPower / area).toFixed(0),
                volumetricPower: (finalPower / (params.algae.volume / 1000)).toFixed(2),
                resistance: internalResistance.toFixed(1),
                efficiency: Math.min(energyEfficiency * algaeProps.efficiency, 20).toFixed(1),
                coulombicEfficiency: Math.min(coulombicEfficiency, 100).toFixed(1),
                energyRecovery: Math.min(energyRecovery, 100).toFixed(1)
            };
        }

        function calculateSolutionResistance() {
            const params = FuelCellDesigner.parameters;
            
            // Ionic strength based on medium type
            const ionicStrengths = {
                bg11: 20, // mM
                tris: 30,
                bold: 15,
                f2: 35,
                zarrouk: 50,
                custom: 25
            };
            
            const ionicStrength = ionicStrengths[params.medium.type];
            const conductivity = ionicStrength * 0.01; // S/m (simplified)
            
            const distance = params.electrodes.separation / 100; // m
            const area = params.electrodes.area / 10000; // m²
            
            return distance / (conductivity * area);
        }

        function calculateCO2Fixation(algaeProps, envFactors) {
            const params = FuelCellDesigner.parameters;
            
            const baseRate = algaeProps.co2FixationRate;
            const densityEffect = params.algae.density / 5;
            const volumeEffect = params.algae.volume / 100;
            const co2Factor = envFactors.co2;
            const growthFactor = envFactors.growth;
            
            // Flow rate effect
            let flowEffect = 1;
            if (params.flow.operationMode === 'continuous') {
                flowEffect = 1 + (params.flow.flowRate / 100) * 0.5;
            }
            
            // Mixing effect
            const mixingEffect = 1 + (params.flow.mixingSpeed / 500) * 0.2;
            
            return (baseRate * densityEffect * volumeEffect * co2Factor * 
                   growthFactor * flowEffect * mixingEffect).toFixed(0);
        }

        // ==========================================
        // UI UPDATE FUNCTIONS
        // ==========================================
        
        function updatePerformanceDisplay() {
            const perf = FuelCellDesigner.parameters.performance;
            
            // Update values
            document.getElementById('power-output').innerHTML = 
                `${perf.power}<span class="metric-unit">mW</span>`;
            document.getElementById('power-density').innerHTML = 
                `${perf.powerDensity}<span class="metric-unit">mW/m²</span>`;
            document.getElementById('efficiency').innerHTML = 
                `${perf.efficiency}<span class="metric-unit">%</span>`;
            document.getElementById('voltage').innerHTML = 
                `${perf.voltage}<span class="metric-unit">V</span>`;
            document.getElementById('current').innerHTML = 
                `${perf.current}<span class="metric-unit">mA</span>`;
            document.getElementById('resistance').innerHTML = 
                `${perf.resistance}<span class="metric-unit">Ω</span>`;
            document.getElementById('co2-fixation').innerHTML = 
                `${perf.co2Fixation}<span class="metric-unit">mg/L/h</span>`;
            document.getElementById('coulombic-efficiency').innerHTML = 
                `${perf.coulombicEfficiency}<span class="metric-unit">%</span>`;
            
            // Update advanced metrics
            if (FuelCellDesigner.state.ui.advancedMode) {
                document.getElementById('energy-recovery').innerHTML = 
                    `${perf.energyRecovery}<span class="metric-unit">%</span>`;
                document.getElementById('volumetric-power').innerHTML = 
                    `${perf.volumetricPower}<span class="metric-unit">W/m³</span>`;
            }
            
            // Update progress bars
            updateProgressBar('power-bar', perf.power, 50);
            updateProgressBar('density-bar', perf.powerDensity, 5000);
            updateProgressBar('efficiency-bar', perf.efficiency, 20);
        }

        function updateProgressBar(id, value, max) {
            const percentage = Math.min((value / max) * 100, 100);
            const bar = document.getElementById(id);
            if (bar) {
                bar.style.width = percentage + '%';
                
                // Color gradient based on performance
                if (percentage > 75) {
                    bar.style.background = 'linear-gradient(90deg, #00ff88, #00ffff)';
                } else if (percentage > 50) {
                    bar.style.background = 'linear-gradient(90deg, #ffaa00, #00ff88)';
                } else {
                    bar.style.background = 'linear-gradient(90deg, #ff4444, #ffaa00)';
                }
            }
        }

        function updateAllDisplays() {
            const params = FuelCellDesigner.parameters;
            
            // Update all parameter displays
            document.getElementById('algae-type-value').textContent = 
                document.getElementById('algae-type').options[document.getElementById('algae-type').selectedIndex].text;
            document.getElementById('cell-density-value').textContent = 
                `${params.algae.density.toFixed(1)} × 10⁶ cells/mL`;
            document.getElementById('culture-volume-value').textContent = 
                `${